{% extends "layout.html" %}

{% block content %}
<div class="fire-starter">
    <h1 class="logo">å¤œç„šãç«
        <span style="display: block; font-size: 0.5em; letter-spacing: 0.2em; opacity: 0.8; margin-top: 0.2rem;">
            - Yotakibi -
        </span>
    </h1>
    <p class="intro">
        è¨€è‘‰ã¨ã„ã†åã®è–ªã‚’ç„šã¹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br>
        æ—¥è¨˜ã‚„å¥½ããªã‚‚ã®ã€æ¥½ã—ã‹ã£ãŸã“ã¨ã‚„æ‚²ã—ã‹ã£ãŸã“ã¨ã€<br>
        ä»Šå¤œã¯ãªã«ã‚’ç„šã¹ã¾ã—ã‚‡ã†ã€‚
    </p>
    <div class="guide-nav">
        <a href="{{ url_for('main.manual', source='write') }}" class="guide-link">
            å¤œç„šãç«ã®æ­©ãæ–¹
        </a>
    </div>

    <style>
        .guide-nav {
            text-align: center;
            margin: 1.5rem 0 1rem 0;
        }

        .guide-link {
            display: inline-block;
            color: #F5DEB3;
            background: #2C241B;
            padding: 0.6rem 1.5rem;
            border-radius: 30px;
            border: 1px solid #8B4513;
            font-size: 0.95rem;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .guide-link:hover {
            background: #3E3226;
            border-color: #D4AF37;
            color: #FFF;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
        }
    </style>

    <form action="{{ url_for('post.write') }}" method="POST" class="diary-form" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div class="form-group">
            <label for="content">è–ªï¼ˆä»Šæ—¥ã®è¨€è‘‰ï¼‰</label>
            <textarea name="content" id="content" rows="6" placeholder="ç‹¬ã‚Šã®å¤œã‚‚æ‚ªããªã„ã€‚"
                required>{{ kept_content if kept_content else '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="aikotoba">ç¨®ç«</label>

            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" name="aikotoba" id="aikotoba" placeholder="ãã‚‡ã†ã®ãŸã­ã³" required autocomplete="off"
                    style="flex: 1;">

                <button type="button" onclick="generateRandomKey()"
                    style="background: none; border: 1px solid #5C4A3D; color: #D4AF37; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; font-size: 0.9rem;">
                    ğŸ² ç”Ÿæˆ
                </button>
            </div>

            <span class="hint">
                ç¨®ç«ï¼ˆåˆè¨€è‘‰ï¼‰ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ã€‚<br>
                ã€Œã­ã“ã€ã€Œç©ºã€ã®ã‚ˆã†ãªç°¡å˜ãªè¨€è‘‰ã¯ã€å¶ç„¶èª°ã‹ã¨é‡ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
                è‡ªåˆ†ã ã‘ã®ç§˜å¯†ã«ã—ãŸã„å ´åˆã¯ã€<strong>ç”Ÿæˆãƒœã‚¿ãƒ³</strong>ã‚’æŠ¼ã—ã¦ã€ã‚ãªãŸã ã‘ã®ç‰¹åˆ¥ãªç«ã‚’ä½œã£ã¦ãã ã•ã„ã€‚
            </span>

            {# --- å…¬é–‹è¨­å®šã‚¨ãƒªã‚¢ --- #}
            <div style="margin-top: 1.5rem; background: rgba(62, 50, 40, 0.3); padding: 1rem; border-radius: 4px;">
                <label
                    style="margin-bottom: 0.8rem; border-bottom: 1px dashed #5C4A3D; padding-bottom: 0.5rem; width: 100%; color: #D4AF37;">
                    å…¬é–‹è¨­å®š
                </label>

                {# 1. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ²è¼‰ #}
                <div class="checkbox-group">
                    <input type="checkbox" name="is_timeline_public" id="is_timeline_public" value="1" checked>
                    <label for="is_timeline_public" class="checkbox-label">
                        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è–ªã‚’ãã¹ã‚‹
                    </label>
                </div>
                <p class="hint indent-hint">
                    ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€ç¨®ç«ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã®æ¤œç´¢ä»¥å¤–ã‹ã‚‰ã¯è¦‹ãˆãªããªã‚Šã¾ã™ã€‚
                </p>

                {# 2. åˆè¨€è‘‰ã®å…¬é–‹ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¨­å®šã®å­è¦ç´ ã¨ã—ã¦æ‰±ã†ï¼‰ #}
                <!-- child-checkbox ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦ã€JSã§åˆ¶å¾¡ã—ã‚„ã™ãã—ã¾ã™ -->
                <div class="checkbox-group child-checkbox" id="aikotoba_public_container">
                    <input type="checkbox" name="is_aikotoba_public" id="is_aikotoba_public" value="1">
                    <label for="is_aikotoba_public" class="checkbox-label">
                        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«ç¨®ç«ï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
                    </label>
                </div>
                <p class="hint indent-hint" id="aikotoba_public_hint" style="transition: opacity 0.3s;">
                    é€£è¼‰ãªã©ã€ç¶™ç¶šçš„ã«è¦‹ã¦ã‚‚ã‚‰ã„ãŸã„æ™‚ã«ä¾¿åˆ©ã§ã™ã€‚
                </p>

                {# 3. SNSè¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰ #}
                <div style="margin-top: 1.5rem;">
                    <details class="settings-details">
                        <summary class="settings-summary">
                            SNSã‚·ã‚§ã‚¢ãªã©ã®è¨­å®š
                            <span style="font-size: 0.8em; opacity: 0.7; margin-left: 0.5em;">â–¼</span>
                        </summary>

                        <div class="settings-content">
                            <div class="checkbox-group">
                                <input type="checkbox" name="allow_sns_share" id="allow_sns_share" value="1">
                                <label for="allow_sns_share" class="checkbox-label">
                                    å…¬å¼SNSç­‰ã§ã®ç´¹ä»‹ãƒ»å¼•ç”¨ã‚’è¨±å¯ã™ã‚‹
                                </label>
                            </div>
                            <p class="hint indent-hint">
                                å¤œç„šãç«ã®å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç­‰ã§ã€ç´ æ•µãªç«ã¨ã—ã¦ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                            </p>

                            <div class="checkbox-group child-checkbox">
                                <input type="checkbox" name="allow_aikotoba_sns" id="allow_aikotoba_sns" value="1"
                                    disabled>
                                <label for="allow_aikotoba_sns" class="checkbox-label">
                                    ãã®éš›ã€ç¨®ç«ã‚‚ä½µã›ã¦å…¬é–‹ã—ã¦è‰¯ã„
                                </label>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <style>
                .settings-details {
                    background-color: rgba(44, 36, 27, 0.5);
                    border: 1px solid #5C4A3D;
                    border-radius: 4px;
                    overflow: hidden;
                    transition: all 0.3s;
                }

                .settings-summary {
                    padding: 0.8rem;
                    cursor: pointer;
                    color: #D4AF37;
                    font-size: 0.9rem;
                    list-style: none;
                    outline: none;
                }

                .settings-summary::-webkit-details-marker {
                    display: none;
                }

                .settings-content {
                    padding: 0 1rem 1rem 1rem;
                    border-top: 1px solid rgba(92, 74, 61, 0.3);
                    animation: fadeIn 0.3s ease;
                }

                .indent-hint {
                    margin-left: 1.8rem;
                    margin-bottom: 1rem;
                    font-size: 0.8rem;
                    opacity: 0.7;
                }

                .child-checkbox {
                    margin-left: 1.5rem;
                    opacity: 0.6;
                    transition: opacity 0.3s;
                }

                /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                .child-checkbox.active {
                    opacity: 1;
                }
            </style>

            {# --- ç®¡ç†è€…ç”¨ï¼šæ™‚ã®èª¿æ•´ãƒ‘ãƒãƒ« --- #}
            {% if session.get('is_admin') %}
            <div class="admin-time-control">
                <label for="custom_time" class="time-label">ğŸ•°ï¸ æ™‚ã®èª¿æ•´ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</label>
                <input type="datetime-local" name="custom_time" id="custom_time" class="time-input">
                <span class="hint" style="margin-top: 0.2rem;">
                    æŒ‡å®šã—ãªã„å ´åˆã¯ã€é€šå¸¸é€šã‚Šç¾åœ¨æ™‚é–“ã®æŠ•ç¨¿ã«ãªã‚Šã¾ã™ã€‚
                </span>
            </div>
            <style>
                .admin-time-control {
                    margin-top: 1.5rem;
                    padding: 1rem;
                    border: 1px dashed #D4AF37;
                    border-radius: 4px;
                    background-color: rgba(62, 50, 40, 0.3);
                }

                .time-label {
                    color: #D4AF37;
                    font-size: 0.9rem;
                    margin-bottom: 0.5rem;
                    display: block;
                }

                .time-input {
                    background-color: #2C241B;
                    border: 1px solid #5C4A3D;
                    color: #E0D6C8;
                    padding: 0.5rem;
                    border-radius: 4px;
                    font-family: inherit;
                    width: 100%;
                    color-scheme: dark;
                }
            </style>
            {% endif %}

        </div>

        <button type="submit" class="btn-burn">ç«ã‚’ç„šã¹ã‚‹</button>
    </form>

    <div class="write-back-nav">
        <a href="{{ url_for('main.index') }}" class="write-back-link">
            &lt; ç„šãç«ã«æˆ»ã‚‹
        </a>
    </div>

    <style>
        .write-back-nav {
            margin-top: 2rem;
            text-align: center;
        }

        .write-back-link {
            display: inline-block;
            color: #E0D6C8;
            border: 1px solid #5C4A3D;
            padding: 0.6rem 2rem;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .write-back-link:hover {
            border-color: #D4AF37;
            color: #D4AF37;
            background: rgba(44, 36, 27, 0.8);
        }
    </style>
</div>

<script>
    function generateRandomKey() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = "";
        for (let i = 0; i < 12; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        const input = document.getElementById('aikotoba');
        input.value = result;
        input.style.backgroundColor = "#5C4A3D";
        setTimeout(() => {
            input.style.backgroundColor = "#3E3228";
        }, 200);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. SNSè¨­å®šã®é€£å‹•åˆ¶å¾¡ ---
        const snsShare = document.getElementById('allow_sns_share');
        const snsAikotoba = document.getElementById('allow_aikotoba_sns');
        const snsAikotobaContainer = snsAikotoba.closest('.child-checkbox');

        function updateSnsState() {
            if (snsShare.checked) {
                snsAikotoba.disabled = false;
                snsAikotobaContainer.classList.add('active');
            } else {
                snsAikotoba.checked = false;
                snsAikotoba.disabled = true;
                snsAikotobaContainer.classList.remove('active');
            }
        }
        snsShare.addEventListener('change', updateSnsState);
        updateSnsState();

        // --- 2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¨­å®šã®é€£å‹•åˆ¶å¾¡ï¼ˆä»Šå›è¿½åŠ ï¼‰ ---
        const tlPublic = document.getElementById('is_timeline_public');
        const tlAikotoba = document.getElementById('is_aikotoba_public');
        // è¦ªã®divï¼ˆchild-checkboxã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ãŸã¨ã“ã‚ï¼‰ã‚’å–å¾—
        const tlAikotobaContainer = document.getElementById('aikotoba_public_container');
        const tlAikotobaHint = document.getElementById('aikotoba_public_hint');

        function updateTimelineState() {
            if (tlPublic.checked) {
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¬é–‹ãªã‚‰ã€ç¨®ç«å…¬é–‹ã‚‚é¸ã¹ã‚‹
                tlAikotoba.disabled = false;
                tlAikotobaContainer.classList.add('active');
                tlAikotobaHint.style.opacity = '0.7'; // ãƒ’ãƒ³ãƒˆã‚‚è¦‹ã›ã‚‹
            } else {
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³éå…¬é–‹ãªã‚‰ã€ç¨®ç«å…¬é–‹è¨­å®šã¯ã‚ªãƒ•ï¼†ç„¡åŠ¹åŒ–
                tlAikotoba.checked = false;
                tlAikotoba.disabled = true;
                tlAikotobaContainer.classList.remove('active'); // è–„ãã™ã‚‹
                tlAikotobaHint.style.opacity = '0.3'; // ãƒ’ãƒ³ãƒˆã‚‚è–„ãã™ã‚‹
            }
        }
        tlPublic.addEventListener('change', updateTimelineState);
        updateTimelineState(); // åˆæœŸå®Ÿè¡Œ
    });
</script>
{% endblock %}