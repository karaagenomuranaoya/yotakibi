name: Auto Fire Keeper (AI Bot)

on:
  schedule:
    # 毎日 19:00〜25:00 の間、10分おきに実行
    # (UTC 10:00 - 16:00)
    - cron: '*/10 10-16 * * *'
  
  workflow_dispatch:

jobs:
  ignite_fire:
    runs-on: ubuntu-latest
    steps:
      - name: Call AI Bot API with Random Delay
        env:
          APP_URL: ${{ secrets.APP_URL }} 
          BOT_SECRET: ${{ secrets.AI_BOT_SECRET }}
        run: |
          # --- 1. サイコロを振る（確率でスキップ） ---
          # 0〜2の乱数を生成。 '0' が出たら今回はサボる（約33%の確率でスキップ）
          # -> スキップすると次の実行まで間隔が20分空くことになる
          if [ $((RANDOM % 3)) -eq 0 ]; then
            echo "Skipping this time for randomness."
            exit 0
          fi

          # --- 2. 焦らし（ランダム待機） ---
          # 0 〜 300秒（5分）の間でランダムに待機する
          # これで「19:10:00」のような機械的な時間を防ぐ
          DELAY=$((RANDOM % 300))
          echo "Sleeping for ${DELAY} seconds..."
          sleep $DELAY

          # --- 3. 実行 ---
          echo "Calling AI Fire Keeper..."
          curl -v -X POST "${APP_URL}/api/bot/ignite" \
               -H "X-Bot-Secret: ${BOT_SECRET}" \
               -H "Content-Type: application/json"