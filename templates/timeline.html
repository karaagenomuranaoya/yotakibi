{% extends "layout.html" %}

{% block content %}
<div class="timeline-container">

    <header class="timeline-header">
        <h2 class="page-title">
            {% if search_query %}
            「{{ search_query }}」の火
            {% else %}
            夜の焚き火
            {% endif %}
        </h2>

        <form action="{{ url_for('search') }}" method="GET" class="search-form">
            <input type="text" name="q" placeholder="種火..." value="{{ search_query if search_query else '' }}">
            <button type="submit">火を辿る</button>
        </form>
    </header>

    {% if session.get('my_aikotoba') and not search_query %}
    <div class="my-info">
        <p>あなたの種火 ： <strong>{{ session['my_aikotoba'] }}</strong></p>
        <a href="{{ url_for('search', q=session['my_aikotoba']) }}" class="link-check">{{ session['my_aikotoba']
            }}の火を見に行く</a>
    </div>
    {% endif %}

    <div class="diary-list">
        {% for diary in diaries %}
        <div class="diary-card">
            <div class="diary-meta">
                <span class="diary-date">{{ diary.created_at.strftime('%Y.%m.%d %H:%M') }}</span>

                {% if diary.is_public %}
                <span class="diary-id public">種火: {{ diary.aikotoba }}</span>
                {% else %}
                <span class="diary-id">#{{ diary.id }} (秘密の火)</span>
                {% endif %}
            </div>

            {# --- 長文判定ロジック --- #}
            {% set is_long = (diary.content|length > 140) or (diary.content.count('\n') > 5) %}

            <div class="diary-body {% if is_long %}collapsed{% endif %}" id="diary-body-{{ diary.id }}">{{ diary.content
                }}</div>

            {% if is_long %}
            {# ★変更: 関数名を toggleDiary にし、ボタンを消さずに残します #}
            <button class="read-more-btn" onclick="toggleDiary('{{ diary.id }}', this)">
                もっと火にあたる
            </button>
            {% endif %}

        </div> {% else %}
        <div class="no-fire">
            <p>まだ、火は灯っていません。</p>
        </div>
        {% endfor %}
    </div>

    <div class="back-link">
        {% if search_query %}
        <a href="{{ url_for('timeline') }}" style="margin-right: 1.5rem;">全ての火に戻る</a>
        {% endif %}

        <a href="{{ url_for('index') }}">もう一度、薪をくべる</a>
    </div>
</div>

<script>
    function toggleDiary(id, btn) {
        const body = document.getElementById('diary-body-' + id);

        // 現在 collapsed クラスがついているか確認
        if (body.classList.contains('collapsed')) {
            // --- 展開する処理 ---
            body.classList.remove('collapsed');

            // CSSのmaskプロパティを無効化して全文表示
            body.style.maxHeight = 'none';
            body.style.maskImage = 'none';
            body.style.webkitMaskImage = 'none';

            // ボタンの文字を変更
            btn.textContent = '火から離れる'; // 閉じるボタン
        } else {
            // --- 閉じる（折りたたむ）処理 ---
            body.classList.add('collapsed');

            // スタイルを削除してCSSクラスの定義に戻す
            body.style.maxHeight = null;
            body.style.maskImage = null;
            body.style.webkitMaskImage = null;

            // ボタンの文字を元に戻す
            btn.textContent = 'もっと火にあたる';

            // 閉じたときにカードの頭が見えるように少しスクロール調整しても親切かもしれません（任意）
            // btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
</script>

{% endblock %}