{% extends "layout.html" %}

{% block content %}
<div class="timeline-container">

    <div style="text-align: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid #5C4A3D;">
        <h1 class="logo" style="margin-bottom: 1rem;">夜焚き火</h1>
        <p style="font-size: 0.9rem; opacity: 0.8; line-height: 1.8;">
            ここは、夜19時から深夜1時までだけ開く秘密の焚き火場。<br>
            誰にも言えない言葉を薪にして<br>
            静かに火に焚べる場所です。<br>
            <br>
            匿名で日記を書き、誰かの火にあたる。<br>
            そんな夜の過ごし方を。
        </p>
        <div class="guide-nav">
            <a href="{{ url_for('manual') }}" class="guide-link">
                夜焚き火の歩き方
            </a>
        </div>

        <style>
            .guide-nav {
                text-align: center;
                margin: 1.5rem 0 2.5rem 0;
                /* 上下の余白を少し広げました */
            }

            .guide-link {
                display: inline-block;
                /* 文字色を明るい小麦色に変更 */
                color: #F5DEB3;
                /* 背景を少し明るい焦げ茶色に */
                background: #2C241B;
                padding: 0.6rem 1.5rem;
                border-radius: 30px;
                /* 枠線を最初からはっきり表示 */
                border: 1px solid #8B4513;
                font-size: 0.95rem;
                text-decoration: none;
                transition: all 0.3s ease;
                /* 影をつけて少し浮き上がらせる */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            }

            .guide-link:hover {
                background: #3E3226;
                border-color: #D4AF37;
                /* ホバー時に枠が金に */
                color: #FFF;
                /* ホバー時に文字を白く */
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
                transform: translateY(-2px);
                /* 少しだけふわっと浮く */
            }
        </style>

        <a href="{{ url_for('write') }}" class="btn-burn"
            style="display: inline-block; width: auto; padding: 0.8rem 2rem; margin-top: 1.5rem; text-decoration: none;">
            薪をくべる（書く）
        </a>
    </div>


    <header class="timeline-header">
        <h2 class="page-title">
            {% if search_query %}
            「{{ search_query }}」の火
            {% else %}
            燃えている火
            {% endif %}
        </h2>

        <form action="{{ url_for('search') }}" method="GET" class="search-form">
            <input type="text" name="q" placeholder="種火..." value="{{ search_query if search_query else '' }}">
            <button type="submit">火を辿る</button>
        </form>
    </header>

    {% if session.get('my_aikotoba') and not search_query %}
    <div class="my-info">
        <p>あなたの種火 ： <strong>{{ session['my_aikotoba'] }}</strong></p>
        <a href="{{ url_for('search', q=session['my_aikotoba']) }}" class="link-check">{{ session['my_aikotoba']
            }}の火を見に行く</a>
    </div>
    {% endif %}

    <div class="diary-list">
        {% for diary in diaries %}
        <div class="diary-card">
            <div class="diary-meta">
                <span class="diary-date">{{ diary.created_at.strftime('%Y.%m.%d %H:%M') }}</span>

                {% if diary.is_public %}
                <span class="diary-id public">種火: {{ diary.aikotoba }}</span>
                {% else %}
                <span class="diary-id">#{{ diary.id }} (秘密の火)</span>
                {% endif %}
            </div>

            {# --- 長文判定ロジック --- #}
            {% set is_long = (diary.content|length > 140) or (diary.content.count('\n') > 5) %}

            <div class="diary-body {% if is_long %}collapsed{% endif %}" id="diary-body-{{ diary.id }}">{{ diary.content
                }}</div>

            {% if is_long %}
            <button class="read-more-btn" onclick="toggleDiary('{{ diary.id }}', this)">
                もっと火にあたる
            </button>
            {% endif %}

        </div>
        {% else %}
        <div class="no-fire">
            <p>まだ、火は灯っていません。</p>
        </div>
        {% endfor %}
    </div>

    <div class="back-link">
        {% if search_query %}
        <a href="{{ url_for('index') }}" style="margin-right: 1.5rem;">全ての火に戻る</a>
        {% endif %}

        <a href="{{ url_for('write') }}">もう一度、薪をくべる</a>
    </div>
</div>

<script>
    function toggleDiary(id, btn) {
        const body = document.getElementById('diary-body-' + id);

        if (body.classList.contains('collapsed')) {
            body.classList.remove('collapsed');
            body.style.maxHeight = 'none';
            body.style.maskImage = 'none';
            body.style.webkitMaskImage = 'none';
            btn.textContent = '火から離れる';
        } else {
            body.classList.add('collapsed');
            body.style.maxHeight = null;
            body.style.maskImage = null;
            body.style.webkitMaskImage = null;
            btn.textContent = 'もっと火にあたる';
        }
    }
</script>

{% endblock %}