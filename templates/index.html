{% extends "layout.html" %}

{% block content %}
<div class="timeline-container">

    <div style="text-align: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid #5C4A3D;">
        <h1 class="logo" style="margin-bottom: 1rem;">
            å¤œç„šãç«
            <span style="display: block; font-size: 0.5em; letter-spacing: 0.2em; opacity: 0.8; margin-top: 0.2rem;">
                - Yotakibi -
            </span>
        </h1><br>
        <p style="font-size: 0.9rem; opacity: 0.8; line-height: 1.8;">
            ã“ã“ã¯ç§˜å¯†ã®ç„šãç«å ´ã€‚<br>
            èª°ã«ã‚‚è¨€ãˆãªã„è¨€è‘‰ã‚’è–ªã«ã—ã¦<br>
            é™ã‹ã«ç«ã«ç„šã¹ã‚‹å ´æ‰€ã§ã™ã€‚<br>
            <br>
            åŒ¿åã§æ—¥è¨˜ã‚’æ›¸ãã€èª°ã‹ã®ç«ã«ã‚ãŸã‚‹ã€‚<br>
            ãã‚“ãªå¤œã®éã”ã—æ–¹ã‚’ã€‚
        </p>
        <div class="guide-nav">
            <a href="{{ url_for('manual') }}" class="guide-link">
                å¤œç„šãç«ã®æ­©ãæ–¹
            </a>
        </div>

        <style>
            .guide-nav {
                text-align: center;
                /* ä¸Šã®ä½™ç™½ã¯ç¶­æŒã—ã¤ã¤ã€ä¸‹ã®ä½™ç™½ã‚’ 2.5rem -> 1rem ã«è©°ã‚ã¾ã—ãŸ */
                margin: 1.5rem 0 1rem 0;
            }

            .guide-link {
                display: inline-block;
                /* æ–‡å­—è‰²ã‚’æ˜ã‚‹ã„å°éº¦è‰²ã«å¤‰æ›´ */
                color: #F5DEB3;
                /* èƒŒæ™¯ã‚’å°‘ã—æ˜ã‚‹ã„ç„¦ã’èŒ¶è‰²ã« */
                background: #2C241B;
                padding: 0.6rem 1.5rem;
                border-radius: 30px;
                /* æ ç·šã‚’æœ€åˆã‹ã‚‰ã¯ã£ãã‚Šè¡¨ç¤º */
                border: 1px solid #8B4513;
                font-size: 0.95rem;
                text-decoration: none;
                transition: all 0.3s ease;
                /* å½±ã‚’ã¤ã‘ã¦å°‘ã—æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            }

            .guide-link:hover {
                background: #3E3226;
                border-color: #D4AF37;
                /* ãƒ›ãƒãƒ¼æ™‚ã«æ ãŒé‡‘ã« */
                color: #FFF;
                /* ãƒ›ãƒãƒ¼æ™‚ã«æ–‡å­—ã‚’ç™½ã */
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
                transform: translateY(-2px);
                /* å°‘ã—ã ã‘ãµã‚ã£ã¨æµ®ã */
            }
        </style>

        <a href="{{ url_for('write') }}" class="btn-burn"
            style="display: inline-block; width: auto; padding: 0.8rem 2rem; margin-top: 0.5rem; text-decoration: none;">
            è–ªã‚’ãã¹ã‚‹ï¼ˆæ›¸ãï¼‰
        </a>
    </div>


    <header class="timeline-header">
        <h2 class="page-title">
            {% if search_query %}
            ã€Œ{{ search_query }}ã€ã®ç«
            {% else %}
            ç‡ƒãˆã¦ã„ã‚‹ç«
            {% endif %}
        </h2>

        <form action="{{ url_for('search') }}" method="GET" class="search-form">
            <input type="text" name="q" placeholder="ç¨®ç«..." value="{{ search_query if search_query else '' }}">
            <button type="submit">ç«ã‚’è¾¿ã‚‹</button>
        </form>
    </header>

    {% if session.get('my_aikotoba') and not search_query %}
    <div class="my-info">
        <p>ã‚ãªãŸã®ç¨®ç« ï¼š <strong>{{ session['my_aikotoba'] }}</strong></p>
        <a href="{{ url_for('search', q=session['my_aikotoba']) }}" class="link-check">{{ session['my_aikotoba']
            }}ã®ç«ã‚’è¦‹ã«è¡Œã</a>
    </div>
    {% endif %}

    <div class="diary-list">
        {% for diary in diaries %}
        <div class="diary-card">
            <div class="diary-meta">
                <span class="diary-date">{{ diary.created_at.strftime('%Y.%m.%d %H:%M') }}</span>

                {# --- ã“ã“ã‚’ä¿®æ­£ --- #}
                {% if diary.show_aikotoba %}
                {# ãƒã‚§ãƒƒã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ™‚ã ã‘ç¨®ç«ã‚’è¡¨ç¤º #}
                <a href="{{ url_for('search', q=diary.aikotoba) }}" style="text-decoration: none;">
                    <span class="diary-id public">ç¨®ç«: {{ diary.aikotoba }}</span>
                </a>
                {% else %}
                {# ãƒã‚§ãƒƒã‚¯ãŒãªã„æ™‚ã¯éš ã™ #}
                <span class="diary-id">#{{ diary.id }} (ç§˜å¯†ã®ç«)</span>
                {% endif %}
                {# --- ã“ã“ã¾ã§ --- #}
            </div>

            {# --- é•·æ–‡åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ --- #}
            {% set is_long = (diary.content|length > 140) or (diary.content.count('\n') > 5) %}

            <div class="diary-body {% if is_long %}collapsed{% endif %}" id="diary-body-{{ diary.id }}">{{ diary.content
                }}</div>

            {% if is_long %}
            <button class="read-more-btn" onclick="toggleDiary('{{ diary.id }}', this)">
                ã‚‚ã£ã¨ç«ã«ã‚ãŸã‚‹
            </button>
            {% endif %}

            {# --- ç®¡ç†è€…ç”¨å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆã“ã“ã«è¿½åŠ ï¼‰ --- #}
            {% if session.get('is_admin') %}
            <form action="{{ url_for('extinguish', diary_id=diary.id) }}" method="POST"
                style="text-align: right; margin-top: 1.5rem; opacity: 0.8;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" onclick="return confirm('æœ¬å½“ã«ã“ã®ç«ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')"
                    style="background: none; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-family: inherit; transition: all 0.2s;">
                    ğŸš« æ¶ˆç«ï¼ˆå‰Šé™¤ï¼‰
                </button>
                <style>
                    button[type="submit"]:hover {
                        background-color: rgba(255, 107, 107, 0.1);
                    }
                </style>
            </form>
            {% endif %}

        </div>
        {% else %}
        <div class="no-fire">
            <p>ã¾ã ã€ç«ã¯ç¯ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>
        </div>
        {% endfor %}
    </div>

    <div class="back-link">
        {% if search_query %}
        <a href="{{ url_for('index') }}">å…¨ã¦ã®ç«ã«æˆ»ã‚‹</a>
        <a href="{{ url_for('write') }}">ã‚‚ã†ä¸€åº¦ã€è–ªã‚’ãã¹ã‚‹</a>
        {% endif %}
    </div>
</div>

<script>
    function toggleDiary(id, btn) {
        const body = document.getElementById('diary-body-' + id);

        if (body.classList.contains('collapsed')) {
            body.classList.remove('collapsed');
            body.style.maxHeight = 'none';
            body.style.maskImage = 'none';
            body.style.webkitMaskImage = 'none';
            btn.textContent = 'ç«ã‹ã‚‰é›¢ã‚Œã‚‹';
        } else {
            body.classList.add('collapsed');
            body.style.maxHeight = null;
            body.style.maskImage = null;
            body.style.webkitMaskImage = null;
            btn.textContent = 'ã‚‚ã£ã¨ç«ã«ã‚ãŸã‚‹';
        }
    }
</script>

{% endblock %}