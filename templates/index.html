{% extends "layout.html" %}

{% block content %}
<div class="timeline-container">

    {# --- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ --- #}
    <div style="text-align: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid #5C4A3D;">
        <h1 class="logo" style="margin-bottom: 1rem;">
            å¤œç„šãç«
            <span style="display: block; font-size: 0.5em; letter-spacing: 0.2em; opacity: 0.8; margin-top: 0.2rem;">
                - Yotakibi -
            </span>
        </h1><br>
        <p style="font-size: 0.9rem; opacity: 0.8; line-height: 1.8;">
            ã“ã“ã¯ç§˜å¯†ã®ç„šãç«å ´ã€‚<br>
            æ—¥ã€…ã®è¨€è‘‰ã‚’è–ªã«ã—ã¦<br>
            é™ã‹ã«ç«ã«ç„šã¹ã‚‹å ´æ‰€ã§ã™ã€‚<br>
            <br>
            åŒ¿åã§ä½•ã‹ã‚’ç¶´ã‚Šã€èª°ã‹ã®ç«ã«ã‚ãŸã‚‹ã€‚<br>
            ãã‚“ãªå¤œã®éã”ã—æ–¹ã‚’ã€‚
        </p>
        <div class="guide-nav">
            <a href="{{ url_for('manual', source='index') }}" class="guide-link">
                å¤œç„šãç«ã®æ­©ãæ–¹
            </a>
        </div>

        <style>
            .guide-nav {
                text-align: center;
                margin: 1.5rem 0 1rem 0;
            }

            .guide-link {
                display: inline-block;
                color: #F5DEB3;
                background: #2C241B;
                padding: 0.6rem 1.5rem;
                border-radius: 30px;
                border: 1px solid #8B4513;
                font-size: 0.95rem;
                text-decoration: none;
                transition: all 0.3s ease;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            }

            .guide-link:hover {
                background: #3E3226;
                border-color: #D4AF37;
                color: #FFF;
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
                transform: translateY(-2px);
            }
        </style>

        <a href="{{ url_for('write') }}" class="btn-burn"
            style="display: inline-block; width: auto; padding: 0.8rem 2rem; margin-top: 0.5rem; text-decoration: none;">
            è–ªã‚’ãã¹ã‚‹ï¼ˆæ›¸ãï¼‰
        </a>
    </div>

    {# --- æ¤œç´¢ãƒãƒ¼ --- #}
    <header class="timeline-header">
        <h2 class="page-title">
            {% if search_query %}
            ã€Œ{{ search_query }}ã€ã®ç«
            {% else %}
            ç‡ƒãˆã¦ã„ã‚‹ç«
            {% endif %}
        </h2>

        <form action="{{ url_for('search') }}" method="GET" class="search-form">
            <input type="text" name="q" placeholder="ç¨®ç«..." value="{{ search_query if search_query else '' }}">
            <button type="submit">ç«ã‚’è¾¿ã‚‹</button>
        </form>
    </header>

    {% if session.get('my_aikotoba') and not search_query %}
    <div class="my-info">
        <p>ã‚ãªãŸã®ç¨®ç« ï¼š <strong>{{ session['my_aikotoba'] }}</strong></p>
        <a href="{{ url_for('search', q=session['my_aikotoba']) }}" class="link-check">{{ session['my_aikotoba']
            }}ã®ç«ã‚’è¦‹ã«è¡Œã</a>
    </div>
    {% endif %}

    {# --- æ—¥è¨˜ãƒªã‚¹ãƒˆ --- #}
    <div class="diary-list">
        {% for diary in diaries %}
        <div class="diary-card">
            <div class="diary-meta">
                <span class="diary-date">{{ diary.created_at.strftime('%Y.%m.%d %H:%M') }}</span>

                {% if diary.is_aikotoba_public %}
                <a href="{{ url_for('search', q=diary.aikotoba) }}" style="text-decoration: none;">
                    <span class="diary-id public">ç¨®ç«: {{ diary.aikotoba }}</span>
                </a>
                {% else %}
                <span class="diary-id">#{{ diary.id }} (ç§˜å¯†ã®ç«)</span>
                {% endif %}
            </div>

            {% set is_long = (diary.content|length > 140) or (diary.content.count('\n') > 5) %}

            <div class="diary-body {% if is_long %}collapsed{% endif %}" id="diary-body-{{ diary.id }}">{{ diary.content
                }}</div>

            {% if is_long %}
            <button class="read-more-btn" onclick="toggleDiary('{{ diary.id }}', this)">
                ã‚‚ã£ã¨ç«ã«ã‚ãŸã‚‹
            </button>
            {% endif %}

            {# --- ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ«ï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼‰ --- #}
            {% if session.get('is_admin') %}
            <div class="admin-panel">
                <details>
                    <summary class="admin-summary">ğŸ”¥ ç®¡ç†ãƒ»ãƒ¡ãƒ¢</summary>
                    <div class="admin-content">
                        {# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± #}
                        <div class="admin-info">
                            <small>UUID: {{ diary.uuid }}</small><br>
                            <small>IP Hash: <span title="{{ diary.ip_hash }}">{{ diary.ip_hash|truncate(10, True) if
                                    diary.ip_hash else 'None' }}...</span></small><br>
                            <small>UA: {{ diary.user_agent|truncate(30, True) if diary.user_agent else 'None' }}</small>
                            <div style="margin-top: 4px; border-top: 1px solid #555; padding-top: 4px;">
                                <small>SNSè¨±å¯: {{ 'âœ…' if diary.allow_sns_share else 'âŒ' }}</small> |
                                <small>SNSç¨®ç«: {{ 'âœ…' if diary.allow_aikotoba_sns else 'âŒ' }}</small>
                            </div>
                        </div>

                        {# ãƒ¡ãƒ¢æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  #}
                        <form action="{{ url_for('update_memo', diary_id=diary.id) }}" method="POST"
                            class="admin-memo-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <textarea name="memo" placeholder="ç®¡ç†è€…ãƒ¡ãƒ¢ï¼ˆéå…¬é–‹ï¼‰"
                                rows="2">{{ diary.admin_memo if diary.admin_memo else '' }}</textarea>
                            <button type="submit" class="btn-memo-save">ä¿å­˜</button>
                        </form>

                        {# æ¡ä»¶ï¼šSNSã‚·ã‚§ã‚¢è¨±å¯(allow_sns_share) ã‹ã¤ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¬é–‹(is_timeline_public) ã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º #}
                        {% if diary.allow_sns_share and diary.is_timeline_public %}
                        <button type="button" {# allow_aikotoba_sns (ç¨®ç«å…¬é–‹è¨±å¯) ã‚‚å¼•æ•°ã«è¿½åŠ ã—ã¦ãŠãã¾ã™ #}
                            onclick="togglePin('{{ diary.id }}', `{{ diary.content|replace('`', '') }}`, '{{ diary.aikotoba }}', {{ 'true' if diary.allow_aikotoba_sns else 'false' }})"
                            class="btn-pin" id="btn-pin-{{ diary.id }}">
                            ğŸ“Œ keep
                        </button>
                        {% else %}
                        {# SNSä¸å¯ãªã©ã®å ´åˆã¯ã€èª¤æ“ä½œé˜²æ­¢ã®ãŸã‚ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆã‚ã‚‹ã„ã¯Disabledãªã‚¢ã‚¤ã‚³ãƒ³ã ã‘ç½®ãï¼‰ #}
                        <span style="font-size:0.8rem; opacity:0.3; padding: 4px; cursor: not-allowed;"
                            title="ã“ã®ç«ã¯SNSã¸ã®æŒã¡å‡ºã—ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“">
                            ğŸ”’ keepä¸å¯
                        </span>
                        {% endif %}

                        {# æ¶ˆç«ãƒœã‚¿ãƒ³ #}
                        <form action="{{ url_for('extinguish', diary_id=diary.id) }}" method="POST"
                            style="text-align: right; margin-top: 0.5rem;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" onclick="return confirm('æœ¬å½“ã«ã“ã®ç«ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç®¡ç†è€…æ¨©é™ï¼šéè¡¨ç¤ºã«ã—ã¾ã™ï¼‰')"
                                class="btn-extinguish">
                                ğŸš« æ¶ˆç«ï¼ˆéè¡¨ç¤ºï¼‰
                            </button>
                        </form>
                    </div>
                </details>
            </div>

            <style>
                .admin-panel {
                    margin-top: 1.5rem;
                    border: 1px solid #8B4513;
                    background-color: rgba(0, 0, 0, 0.3);
                    border-radius: 4px;
                    font-size: 0.85rem;
                }

                .admin-summary {
                    padding: 0.5rem;
                    cursor: pointer;
                    color: #ffb74d;
                    background-color: rgba(139, 69, 19, 0.2);
                    list-style: none;
                }

                .admin-content {
                    padding: 0.8rem;
                }

                .admin-info {
                    font-family: monospace;
                    color: #aaa;
                    margin-bottom: 0.8rem;
                    line-height: 1.4;
                }

                .admin-memo-form textarea {
                    width: 100%;
                    background: #222;
                    color: #fff;
                    border: 1px solid #555;
                    padding: 0.5rem;
                    font-size: 0.8rem;
                    margin-bottom: 0.3rem;
                }

                .btn-memo-save {
                    background: #5C4A3D;
                    color: #fff;
                    border: none;
                    padding: 2px 8px;
                    cursor: pointer;
                    border-radius: 2px;
                }

                .btn-extinguish {
                    background: none;
                    border: 1px solid #ff6b6b;
                    color: #ff6b6b;
                    padding: 4px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.8rem;
                    transition: all 0.2s;
                }

                .btn-extinguish:hover {
                    background-color: rgba(255, 107, 107, 0.1);
                }
            </style>
            {% endif %}
            {# --- ç®¡ç†ãƒ‘ãƒãƒ«ã“ã“ã¾ã§ --- #}

        </div>
        {% else %}
        <div class="no-fire">
            <p>ã¾ã ã€ç«ã¯ç¯ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>
        </div>
        {% endfor %}
    </div>

    {# --- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ --- #}
    {% if pagination and pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="{{ url_for('index', page=pagination.prev_num) }}" class="page-link">&laquo; å‰ã®å¤œ</a>
        {% else %}
        <span class="page-link disabled">&laquo; å‰ã®å¤œ</span>
        {% endif %}

        <span class="page-info">{{ pagination.page }} / {{ pagination.pages }}</span>

        {% if pagination.has_next %}
        <a href="{{ url_for('index', page=pagination.next_num) }}" class="page-link"> &raquo;</a>
        {% else %}
        <span class="page-link disabled">å‰ã®å¤œ &raquo;</span>
        {% endif %}
    </div>

    <style>
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-top: 3rem;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .page-link {
            color: #D4AF37;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid #5C4A3D;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .page-link:hover:not(.disabled) {
            background-color: #3E3228;
            border-color: #D4AF37;
        }

        .page-link.disabled {
            opacity: 0.3;
            cursor: default;
            border-color: transparent;
        }

        .page-info {
            color: #E0D6C8;
            opacity: 0.7;
            letter-spacing: 0.1em;
        }
    </style>
    {% endif %}

    <div class="back-link">
        {% if search_query %}
        <a href="{{ url_for('index') }}">å…¨ã¦ã®ç«ã«æˆ»ã‚‹</a>
        <a href="{{ url_for('write') }}">ã‚‚ã†ä¸€åº¦ã€è–ªã‚’ãã¹ã‚‹</a>
        {% endif %}
    </div>
</div>

<script>
    function toggleDiary(id, btn) {
        const body = document.getElementById('diary-body-' + id);

        if (body.classList.contains('collapsed')) {
            body.classList.remove('collapsed');
            body.style.maxHeight = 'none';
            body.style.maskImage = 'none';
            body.style.webkitMaskImage = 'none';
            btn.textContent = 'ç«ã‹ã‚‰é›¢ã‚Œã‚‹';
        } else {
            body.classList.add('collapsed');
            body.style.maxHeight = null;
            body.style.maskImage = null;
            body.style.webkitMaskImage = null;
            btn.textContent = 'ã‚‚ã£ã¨ç«ã«ã‚ãŸã‚‹';
        }
    }
</script>

{% if session.get('is_admin') %}
<div id="pin-sidebar" class="pin-sidebar">
    <div class="pin-close-tab" onclick="toggleSidebar()">â–¶</div>

    <div class="pin-header">
        <span>ğŸ“Œ ã‚¹ãƒˆãƒƒã‚¯ (SNSç”¨)</span>
    </div>

    <div id="pin-list" class="pin-list">
    </div>
    <div class="pin-footer">
        <button onclick="clearPins()"
            style="font-size:0.8rem; background:none; border:none; color:#888; cursor:pointer;">å…¨å‰Šé™¤</button>
    </div>
</div>

<div id="pin-toggle" class="pin-toggle" onclick="toggleSidebar()">â—€</div>
<script>
    // --- JSãƒ­ã‚¸ãƒƒã‚¯ ---
    document.addEventListener('DOMContentLoaded', () => {
        renderPins();
        updateButtons();
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('pin-sidebar');
        sidebar.classList.toggle('active');
    }

    // ãƒ”ãƒ³ç•™ã‚åˆ‡ã‚Šæ›¿ãˆï¼ˆisAikotobaOKã‚’è¿½åŠ ï¼‰
    function togglePin(id, content, aikotoba, isAikotobaOK) {
        let pins = JSON.parse(localStorage.getItem('yotakibi_pins') || '[]');
        const existingIndex = pins.findIndex(p => p.id === id);

        if (existingIndex >= 0) {
            pins.splice(existingIndex, 1);
        } else {
            pins.push({ id, content, aikotoba, isAikotobaOK, added_at: new Date().toISOString() });
            document.getElementById('pin-sidebar').classList.add('active');
        }

        localStorage.setItem('yotakibi_pins', JSON.stringify(pins));
        renderPins();
        updateButtons();
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æç”»ï¼ˆç¨®ç«ã®å®‰å…¨æ€§è€ƒæ…®ç‰ˆï¼‰
    function renderPins() {
        const pins = JSON.parse(localStorage.getItem('yotakibi_pins') || '[]');
        const listEl = document.getElementById('pin-list');
        listEl.innerHTML = '';

        if (pins.length === 0) {
            listEl.innerHTML = '<div style="padding:1rem; text-align:center; opacity:0.5; font-size:0.8rem;">ã¾ã ã‚¹ãƒˆãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        pins.forEach(pin => {
            const div = document.createElement('div');
            div.className = 'pin-card';

            // ç¨®ç«å…¬é–‹OKãªã‚‰è¡¨ç¤ºã€NGãªã‚‰éš ã™
            let aikotobaHtml = '';
            if (pin.isAikotobaOK) {
                aikotobaHtml = `
                    <div class="pin-aikotoba" onclick="copyString('${pin.aikotoba}', this)" title="ã‚¿ãƒƒãƒ—ã§ç¨®ç«ã‚’ã‚³ãƒ”ãƒ¼">
                        ğŸ”¥ ${pin.aikotoba}
                    </div>`;
            } else {
                aikotobaHtml = `
                    <div style="font-size:0.7rem; color:#888; border:1px dashed #555; padding:2px 6px; border-radius:4px;">
                        ğŸ”’ ç¨®ç«éå…¬é–‹
                    </div>`;
            }

            div.innerHTML = `
                <div class="pin-meta">
                    <span class="pin-id">#${pin.id}</span>
                    ${aikotobaHtml}
                </div>
                <textarea rows="4" readonly onclick="this.select()">${pin.content}</textarea>
                <div class="pin-actions">
                    <button class="pin-btn-mini" onclick="copyText(this)">æœ¬æ–‡Copy</button>
                    <button class="pin-btn-mini" style="background:#8b3a3a;" onclick="togglePin('${pin.id}')">å‰Šé™¤</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    function updateButtons() {
        const pins = JSON.parse(localStorage.getItem('yotakibi_pins') || '[]');
        document.querySelectorAll('.btn-pin').forEach(btn => {
            btn.classList.remove('pinned');
            btn.textContent = 'ğŸ“Œ keep';
        });

        pins.forEach(pin => {
            const btn = document.getElementById('btn-pin-' + pin.id);
            if (btn) {
                btn.classList.add('pinned');
                btn.textContent = 'âœ… in stock';
            }
        });
    }

    function clearPins() {
        if (confirm('ã‚¹ãƒˆãƒƒã‚¯ã‚’å…¨ã¦ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('yotakibi_pins');
            renderPins();
            updateButtons();
        }
    }

    function copyText(btn) {
        const textarea = btn.parentElement.previousElementSibling;
        textarea.select();
        document.execCommand('copy');
        const original = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = original, 1000);
    }

    function copyString(text, element) {
        navigator.clipboard.writeText(text).then(() => {
            const original = element.innerHTML;
            element.innerHTML = 'âœ¨ Copied!';
            element.style.borderColor = '#fff';
            setTimeout(() => {
                element.innerHTML = original;
                element.style.borderColor = '#5C4A3D';
            }, 1000);
        });
    }
</script>
{% endif %}

{% endblock %}